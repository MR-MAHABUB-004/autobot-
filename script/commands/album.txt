const fs = require("fs/promises");
const fsSync = require("fs"); // For createReadStream
const path = require("path");
const axios = require("axios");

module.exports.config = {
  name: "album",
  version: "2.1.0",
  permission: 0,
  credits: "IMRAN",
  description: "Media",
  prefix: false,
  premium: false,
  category: "media",
  usages: "album",
  cooldowns: 5
};

module.exports.run = async function ({ api, event, args }) {
  const { threadID, senderID } = event;

  if (!args[0]) {
    const menu =
      "====„Äå ùêïùêàùêÉùêÑùêé „Äç====\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
      "ùüô.‚ï∞‚îà‚û§ ùêÄùêãùêéùêç ùêïùêàùêÉùêÑùêéüíî\n" +
      "ùüö.‚ï∞‚îà‚û§ ùêÄùêçùêàùêåùêÑ ùêïùêàùêÉùêÑùêéüòª\n" +
      "ùüõ.‚ï∞‚îà‚û§ ùêÅùêÄùêÅùêò ùêïùêàùêÉùêÑùêéü•∞\n" +
      "ùüú.‚ï∞‚îà‚û§ ùêÇùêëùêîùêíùêá ùêïùêàùêÉùêÑùêéüòç\n" +
      "ùüù.‚ï∞‚îà‚û§ ùêàùêíùêãùêÄùêåùêàùêÇ ùêïùêàùêÉùêÑùêéüïã\n" +
      "ùüû.‚ï∞‚îà‚û§ ùêíùêÄùêÉ ùêïùêàùêÉùêÑùêéüòî\n" +
      "ùüü.‚ï∞‚îà‚û§ ùêãùêéùêïùêÑ ùêïùêàùêÉùêÑùêéüíù\n" +
      "ùü†.‚ï∞‚îà‚û§ ùêçùêÄùêìùêîùêëùêÄùêã ùêïùêàùêÉùêÑùêéüåøüïäÔ∏è\n\n" +
      "===„Äå ùüèùüñ+ ùêïùêàùêÉùêÑùêé „Äç===\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
      "ùü°.‚ï∞‚îà‚û§ ùêáùêéùêëùêçùêò ùêïùêàùêÉùêÑùêéüî•\n" +
      "ùüôùüò.‚ï∞‚îà‚û§ ùêáùêéùêì ùêïùêàùêÉùêÑùêéü•µ\n" +
      "ùüôùüô.‚ï∞‚îà‚û§ ùêàùêìùêÑùêå ùêïùêàùêÉùêÑùêéüîû\n\n" +
      "üì• Reply with a number to get a video.";

    return api.sendMessage(menu, threadID, async (err, info) => {
      if (err) return console.error(err);
      const botID = await api.getCurrentUserID();
      const handleReplyList = global.client.handleReply.get(botID) || [];

      handleReplyList.push({
        name: module.exports.config.name,
        messageID: info.messageID,
        author: senderID
      });

      global.client.handleReply.set(botID, handleReplyList);
    });
  }
};

module.exports.handleReply = async function ({ api, event }) {
  const { threadID, senderID, body, messageReply } = event;
  const botID = await api.getCurrentUserID();
  const handleList = global.client.handleReply.get(botID) || [];

  const handler = handleList.find(h => h.messageID === messageReply?.messageID);
  if (!handler || handler.author !== senderID) return;

  function getVideoLink(choice) {
    const base = "https://imran-api.onrender.com/video";
    switch (choice) {
      case "1": return `${base}/alon`;
      case "2": return `${base}/anime`;
      case "3": return `${base}/baby`;
      case "4": return `${base}/crush`;
      case "5": return `${base}/islam`;
      case "6": return `${base}/sadvideo`;
      case "7": return `${base}/love`;
      case "8": return `${base}/nuture`;
      case "9": return `${base}/horny`;
      case "10": return `${base}/hot`;
      case "11": return `${base}/item`;
      default: return null;
    }
  }

  const videoLink = getVideoLink(body.trim());
  if (!videoLink) return api.sendMessage("‚ùå Invalid number. Please try again.", threadID);

  try {
    const res = await axios.get(videoLink);
    const videoData = res.data.data;
    const caption = res.data.imran || "üé¨ Here's your video!";
       const total = res.data.count || "N/A";
      console.log(videoData);
//
    const videoResponse = await axios.get(videoData, {
      responseType: "arraybuffer"
    });

    const tempPath = path.join(__dirname, "cache", `video_${Date.now()}.mp4`);
    await fs.writeFile(tempPath, Buffer.from(videoResponse.data));

    await api.sendMessage({
      body: `${caption}\n\n¬§„ÄäùêìùêéùêìùêÄùêã ùêïùêàùêÉùêÑùêé: ${total}„Äã¬§`,
      attachment: fsSync.createReadStream(tempPath)
    }, threadID, async () => {
      await fs.unlink(tempPath);
    });

    // Clean up reply listener ok
    const updatedList = handleList.filter(item => item.messageID !== handler.messageID);
    global.client.handleReply.set(botID, updatedList);

  } catch (error) {
    console.error("‚ùå Video fetch error:", error);
    return api.sendMessage("‚ö†Ô∏è Failed to load video. Please try again later.", threadID);
  }
};