const axios = require("axios");
const moment = require("moment-timezone");

module.exports.config = {
  name: "autotime",
  version: "1.0.0",
  credits: "Ryuko Developer",
  permission: 0,
  description: "An example command",
  category: "auto",
  usages: "example",
  prefix: true,
  premium: true,
  cooldown: 0
};

const lastSent = {};
const groupIDs = ["9558591557528359"];
//fi

async function sendVideo(api, threadID, timeSlot) {
  try {
    const response = await axios.get("https://mahabub-apis.vercel.app/mahabub");

    const videoUrl = response.data?.data;
    const title = response.data?.title || "ðŸ”¹ No Title Found";

    if (!videoUrl) {
      return api.sendMessage("âŒ No videos found! (Invalid API Response)", threadID);
    }

    const res = await axios.get(videoUrl, { responseType: "stream" });

    api.sendMessage({
      body: `====== ð—”ð—¨ð—§ð—¢ ð—¦ð—˜ð—¡ð—— ======\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâž ð—¡ð—¼ð˜„ ð—œð˜€: ${timeSlot}\n\nðŸ’¬: ${title}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâž ð—§ð—µð—¶ð˜€ ð—œð˜€ ð—”ð—» ð—”ð˜‚ð˜ð—¼ð—ºð—®ð˜ð—¶ð—° ð— ð—²ð˜€ð˜€ð—®ð—´ð—²`,
      attachment: res.data
    }, threadID);

    lastSent[threadID] = timeSlot;

  } catch (error) {
    console.error("ðŸš¨ API Error:", error);
    api.sendMessage("âŒ Failed to fetch video.", threadID);
  }
}

function formatTime(date) {
  return moment(date).tz("Asia/Dhaka").format("h:mmA").toUpperCase();
}

function scheduleVideo(api) {
  const timeSlots = [
    "4:30AM", "7:30AM", "8:30AM", "9:30AM", "12:30PM",
    "1:30PM", "2:30PM", "4:30PM", "5:30PM",
    "7:30PM", "8:30PM", "9:30PM", "11:30PM", "12:30AM"
  ];

  setInterval(async () => {
    const currentTime = formatTime(new Date());

    if (!timeSlots.includes(currentTime)) return;

    for (const threadID of groupIDs) {
      if (lastSent[threadID] !== currentTime) {
        await sendVideo(api, threadID, currentTime);
      }
    }
  }, 30000);
}

module.exports.onLoad = function ({ api }) {
  if (global.autosendInitialized) return;
  global.autosendInitialized = true;

  scheduleVideo(api);
  console.log("âœ… AutoSend to fixed groups started successfully");
};

module.exports.run = async () => {};
